---
title: "Variance partitioning script"
author: "David S, Mason"
date: "5/6/2021"
output: html_document
---
This is a script for conducting variance partitioning on understory vegetation data collected at 59 sites at Noxumbee National Wildlife Refuge and Tombigbee National Forest during two separate sampling periods. The environmental (explanatory) matrix includes overstory characteristics, soil analyses, and geospatially derived data, among other variables. UTM coordinates also included, so the analyses below includes a section deriving spatial descriptors for use in the variance partitioning. 

## Load packages
```{r echo=false}
library(tidyverse)
library(vegan)
library(ade4)
library(adespatial)
library(spdep)
library(betapart)
library(spdep)
library(corrplot)
library(SoDA) 
library(rgdal)
```

## Bring in the data
```{r echo=false}
spec <- read.csv("data/species.csv") # Species 
head(spec)

env <- read.csv("data/env_coords.csv") # Environmental
head(env)
```

## Selecting species to use in the analyses

First, I use a package develoepd by Kevin McGarigal that identifies common and rare species. Then, I remove those species to generate a reduced species matrix. I will conduct analyses on both datasets.
```{r}
source("code/biostats.r") # attach the code from biostats

occur <- foa.plots(spec)
rare <- which(occur[,2]<5)
common <- which(occur[,2]>95)

red_spec <- spec[,-c(rare,common)]
```

## Transforming the species data 
```{r}
spe.hel <- decostand(spec, "hellinger") 
red.spe.hel <- decostand(red_spec, "hellinger")
```
## Preparing environmental data 

The species data is ready for analysis, but I need to check the environmental data for collinearity. I will begin by removing some redunant variables from the matrix. Date is removed in favor of sampling period, numerical texture proportions are removed in favor of the categorical descriptor. Also, site is dropped because this is not an explanatory variable and spatial descriptors are dropped because these will be dealt with separately. Next, I need to separate the numerical variables from categorical variables for correlation analtses. I conclude this stage by converting disturbance intensity into an ordinal factor.
```{r}
# Drop site, date, spatial descriptors and texture proportions
red.env <- env[,-c(1:4,16,17,18)] 

# Separate the numerical data
env_numeric <- select(red.env, -PERIOD, -TEXTURE, -OWNERSHIP, -DISTURB, -INTENSITY)

# Separate the categorical and ordinal data
env.factors <- select(red.env, PERIOD, TEXTURE, OWNERSHIP, DISTURB, INTENSITY)

# Convert intensity into ordinal 
env.factors$INTENSITY <- factor(red.env$INTENSITY, order = TRUE, levels = c("NONE","LOW", "MED", "HIGH"))
```
### Checking for collinearity 

## Numeric variables

First, I scale all numerical variables and calculate correlations between all pairs. Then, I select all correlations above 0.7 and create a list of variables to be dropped from the dataset. 
```{r}
# Scale the data
red.env.cont.corr <- as.data.frame(scale(env_numeric)) %>% 
								 		cor(method = c("kendall"))

# Create a dataframe
red.env.cont.corr.df <-  as.data.frame(as.table(red.env.cont.corr))

# Filter for values above 0.7
red.env.cont.corr.filt <- red.env.cont.corr.df %>%  
															arrange(desc(Freq)) %>% 
															filter(Freq>0.7)

# Visualize the correlations
corrplot(red.env.cont.corr, tl.cex = 0.5)

# Create a vector of variables to drop
numeric.drop <- c("Morus.rubra", "Cercis.canadensis", "Ilex.decidua",
														 "S", "Asimina.triloba", "Carya.pallida")
```
## Disturbance type and numeric variables

Moving to the categorical variables, I separate disturbance into one vector and create a matrix of all the numeric variables. Then, I calculate a pseudo-r value and look for correlations above 0.7 (there are none).
```{r}
# Correlations among categorical and continuous variables

# DIST
red.env.factor.corr <- red.env %>% 
							select(-PERIOD, -TEXTURE, -OWNERSHIP, -INTENSITY) %>% 
							select(DISTURB, everything())

DIST <- red.env.factor.corr[,1]
red.env.factor.corr <- red.env.factor.corr[,-1]


rsq <- vector()
pseudo.r <- vector()
for(i in 1:84){
	mod <- lm(formula = red.env.factor.corr[,i] ~ DIST, 
					data = red.env.factor.corr)
	rsq <- summary(mod)$r.squared
	pseudo.r[i] <- sqrt(rsq)
}

pseudo.r <- as.data.frame(as.table(pseudo.r)) 
pseudo.r$Var1 <- as.vector(dimnames(red.env.factor.corr)[[2]]) 
```
## Sampling period

# Soil sodium (mg) is highly correlated (>0.7) with sampling period. 
```{r}
red.env.factor.corr <- red.env %>% 
	select(-DISTURB, -TEXTURE, -OWNERSHIP, -INTENSITY) %>% 
	select(PERIOD, everything())

PERIOD <- red.env.factor.corr[,1]
red.env.factor.corr <- red.env.factor.corr[,-1]
rsq <- vector()
pseudo.r <- vector()
for(i in 1:84){
	mod <- lm(formula = red.env.factor.corr[,i] ~ PERIOD, 
					data = red.env.factor.corr)
	rsq <-  summary(mod)$r.squared
	pseudo.r[i] <- sqrt(rsq)
}

pseudo.r <- as.data.frame(as.table(pseudo.r)) 
pseudo.r$Var1 <- as.vector(dimnames(red.env.factor.corr)[[2]]) 
```
## Soil texture and numeric variables

# Quercus pagoda importance value is highly correlated (>0.7) with soil texture
```{r}
red.env.factor.corr <- red.env %>% 
	select(-DISTURB, -TEXTURE, -OWNERSHIP, -INTENSITY) %>% 
	select(PERIOD, everything())

PERIOD <- red.env.factor.corr[,1]
red.env.factor.corr <- red.env.factor.corr[,-1]
rsq <- vector()
pseudo.r <- vector()
for(i in 1:84){
	mod <- lm(formula = red.env.factor.corr[,i] ~ PERIOD, 
					data = red.env.factor.corr)
	rsq <-  summary(mod)$r.squared
	pseudo.r[i] <- sqrt(rsq)
}

pseudo.r <- as.data.frame(as.table(pseudo.r)) 
pseudo.r$Var1 <- as.vector(dimnames(red.env.factor.corr)[[2]]) 
```
## Land onwership and numeric variables

# Distance (m) to highly developed land (DEVHI) is highly correlated (>0.7) with land ownership
```{r}
# OWNERSHIP
red.env.factor.corr <- red.env %>% 
	select(-PERIOD, -DISTURB, -TEXTURE, -INTENSITY) %>% 
	select(OWNERSHIP, everything())

OWNERSHIP <- red.env.factor.corr[,1]
red.env.factor.corr <- red.env.factor.corr[,-1]
rsq <- vector()
pseudo.r <- vector()
for(i in 1:84){
	mod <- lm(formula = red.env.factor.corr[,i] ~ OWNERSHIP, 
					data = red.env.factor.corr)
	rsq <-  summary(mod)$r.squared
	pseudo.r[i] <- sqrt(rsq)
}

pseudo.r <- as.data.frame(as.table(pseudo.r)) 
pseudo.r$Var1 <- as.vector(dimnames(red.env.factor.corr)[[2]]) 
```
## Disturbance intensity and numeric variables

# No numeric variables are highly correlated (>0.7) with land ownership
```{r}
red.env.factor.corr <- red.env %>% 
	select(-PERIOD, -DISTURB, -TEXTURE, -OWNERSHIP) %>% 
	select(INTENSITY, everything())

INTENSITY <- red.env.factor.corr[,1]
red.env.factor.corr <- red.env.factor.corr[,-1]
rsq <- vector()
pseudo.r <- vector()
for(i in 1:84){
	mod <- lm(formula = red.env.factor.corr[,i] ~ INTENSITY, 
					data = red.env.factor.corr)
	rsq <-  summary(mod)$r.squared
	pseudo.r[i] <- sqrt(rsq)
}

pseudo.r <- as.data.frame(as.table(pseudo.r)) 
pseudo.r$Var1 <- as.vector(dimnames(red.env.factor.corr)[[2]]) # nothing
```
## Creating the final environmental matrix

With these results, I can avoid collinearity by dropping highly correlated (>0.7) values. I create a vector of collinear categorical variables and combine this with the vector of collinear numeric variables. I need to use '%!in%' to pull anything in this collinear vector out of the environmental matrix. However, this function filters FOR whatever is in the vector. I need to pull everthing NOT in the vector, so I write a function for to do the opposite.
```{r}
# List of species correlated with categorical variables
categorical.drop <- c("soilNA", "Quercus.pagoda", "DEVHI")

# Combined list of correlated variables to drop
drop.list <- c(numeric.drop, categorical.drop)
# Drop the correlated variables
'%!in%' <- function(x,y){ 
	!('%in%'(x,y)) # make a function to do the opposite of %in%
}

# Bring the data back together
env.temp <- cbind(red.env.factors, scale(red.env.numeric))

# Drop the collinear variables
env.final <- env.temp[which(names(env.temp) %!in% drop.list)]	
```
